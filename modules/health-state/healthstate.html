<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title id="title-ar">Ø­Ø§Ù„ØªÙŠ Ø§Ù„ØµØ­ÙŠØ©</title>
  <title id="title-en" style="display:none;">My Health State</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <style>
    body {background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); min-height: 100vh; margin: 0; font-family: 'Segoe UI', Arial, sans-serif;}
    .container {max-width: 1000px; margin: 40px auto; background: #fff; border-radius: 16px; box-shadow: 0 4px 30px rgba(76, 175, 80, 0.2); padding: 30px;}
    h1 {color:#009688; margin-bottom:18px; text-align:right;}
    .summary {background:#e0f2f1; border-radius:10px; padding:14px 18px; margin-bottom:22px;}
    .summary strong {color:#1976d2;}
    .cards {display:grid; grid-template-columns:1fr 1fr; gap:18px; margin-bottom:22px;}
    @media(max-width:700px){.cards{grid-template-columns:1fr;}}
    .card {background:#f5f5f5; border-radius:12px; padding:16px 12px; box-shadow:0 2px 8px #00968822;}
    .card-title {font-weight:bold; color:#2196F3; margin-bottom:7px;}
    .card-value {font-size:1.5em; font-weight:bold; margin-bottom:5px;}
    .card-note {color:#e53935; font-size:1.05em;}
    .card-note.good {color:#388e3c;}
    .card-note.warn {color:#fbc02d;}
    .notes {background:#fffde7;padding:14px;border-radius:10px;margin-bottom:18px;border:1px solid #ffe082;}
    .btn {display:inline-block;background:#2196F3;color:#fff;padding:10px 24px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;margin-top:8px;}
    .btn:hover {background:#1976d2;}
    #backBtn {
      position: fixed; top: 18px; left: 18px; z-index:99999;
      background: #eee; color: #2196F3; border: none; border-radius: 8px;
      padding: 8px 20px; font-weight: bold; cursor: pointer;
      box-shadow: 0 2px 8px #2196F344;
    }
    #lang-switch {margin-bottom:18px;text-align:left;}
    .lang-btn {border:none;background:#eee;padding:6px 19px;margin:0 3px;border-radius:10px;cursor:pointer;}
    .lang-btn.active, .lang-btn:focus {background:#2196F3;color:#fff;}
    #firstMeasurementModal {
      position: fixed; top:0; left:0; width:100vw; height:100vh;
      background:rgba(0,0,0,0.22); z-index:99999;
      display: flex; align-items: center; justify-content: center;
    }
    #firstMeasurementModal .modal-content {
      background: #fff; padding: 28px 16px 16px 16px;
      border-radius: 14px; box-shadow: 0 2px 18px #00968833;
      min-width: 340px; max-width: 98vw;
    }
    .form-row {display: flex; flex-direction: column; gap: 4px; margin-bottom:12px;}
  </style>
</head>
<body>
  <button onclick="window.history.back()" id="backBtn">
    <span id="back-ar" style="display:block;">Ø±Ø¬ÙˆØ¹</span>
    <span id="back-en" style="display:none;">Back</span>
  </button>
  <div class="container">
    <div id="lang-switch">
      <button class="lang-btn" id="lang-ar" style="font-weight:bold;">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
      <button class="lang-btn" id="lang-en">English</button>
    </div>
    <h1 id="header-ar" style="display:block;">Ø­Ø§Ù„ØªÙŠ Ø§Ù„ØµØ­ÙŠØ©</h1>
    <h1 id="header-en" style="display:none;">My Health State</h1>
    <div class="summary" id="lastMeasurements"></div>
    <div class="cards" id="cards"></div>
    <div class="notes" id="notes"></div>
    <button class="btn" onclick="window.location.href='measurments.html'">
      <span id="btn-update-ar" style="display:block;">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª</span>
      <span id="btn-update-en" style="display:none;">Update Measurements</span>
    </button>
  </div>
  <!-- Ù†Ø§ÙØ°Ø© Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙˆÙ„ Ù‚ÙŠØ§Ø³ ÙÙ‚Ø· -->
  <div id="firstMeasurementModal" style="display:none;">
    <div class="modal-content" dir="auto">
      <div style="text-align:left; margin-bottom:12px;">
        <button class="lang-btn" id="modal-lang-ar" style="font-weight:bold;">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
        <button class="lang-btn" id="modal-lang-en">English</button>
      </div>
      <h2 id="modal-title-ar" style="display:block;">Ø³Ø¬Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„ØµØ­ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰</h2>
      <h2 id="modal-title-en" style="display:none;">Register your first health data</h2>
      <form id="firstMeasurementForm">
        <div class="form-row">
          <label id="label-weight-ar" for="weight" style="display:block;">Ø§Ù„ÙˆØ²Ù†</label>
          <label id="label-weight-en" for="weight" style="display:none;">Weight</label>
          <input type="number" id="weight" required min="20" max="300" step="0.1">
          <select id="weight-unit"><option value="kg" id="weight-unit-ar">ÙƒØ¬Ù…</option><option value="lb" id="weight-unit-en" style="display:none;">lb</option></select>
        </div>
        <div class="form-row">
          <label id="label-height-ar" for="height" style="display:block;">Ø§Ù„Ø·ÙˆÙ„</label>
          <label id="label-height-en" for="height" style="display:none;">Height</label>
          <input type="number" id="height" required min="80" max="250" step="0.1">
          <select id="height-unit"><option value="cm" id="height-unit-ar">Ø³Ù…</option><option value="in" id="height-unit-en" style="display:none;">in</option></select>
        </div>
        <div class="form-row">
          <label id="label-dob-ar" for="dob" style="display:block;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
          <label id="label-dob-en" for="dob" style="display:none;">Date of Birth</label>
          <input type="date" id="dob" required>
        </div>
        <div class="form-row">
          <label id="label-gender-ar" style="display:block;">Ø§Ù„Ù†ÙˆØ¹</label>
          <label id="label-gender-en" style="display:none;">Gender</label>
          <div>
            <label><input type="radio" name="gender" value="male" required>
              <span id="gender-male-ar" style="display:block;">Ø°ÙƒØ±</span>
              <span id="gender-male-en" style="display:none;">Male</span>
            </label>
            <label><input type="radio" name="gender" value="female">
              <span id="gender-female-ar" style="display:block;">Ø£Ù†Ø«Ù‰</span>
              <span id="gender-female-en" style="display:none;">Female</span>
            </label>
          </div>
        </div>
        <div class="form-row">
          <label id="label-waist-ar" for="waist" style="display:block;">Ù…Ø­ÙŠØ· Ø§Ù„Ø®ØµØ±</label>
          <label id="label-waist-en" for="waist" style="display:none;">Waist Circumference</label>
          <input type="number" id="waist" required min="40" max="200" step="0.1">
          <select id="waist-unit"><option value="cm" id="waist-unit-ar">Ø³Ù…</option><option value="in" id="waist-unit-en" style="display:none;">in</option></select>
        </div>
        <div class="form-row">
          <label id="label-hip-ar" for="hip" style="display:block;">Ù…Ø­ÙŠØ· Ø§Ù„ÙˆØ±Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <label id="label-hip-en" for="hip" style="display:none;">Hip Circumference (optional)</label>
          <input type="number" id="hip" min="40" max="200" step="0.1">
          <select id="hip-unit"><option value="cm" id="hip-unit-ar">Ø³Ù…</option><option value="in" id="hip-unit-en" style="display:none;">in</option></select>
        </div>
        <div class="form-row">
          <label id="label-activity-ar" for="activity" style="display:block;">Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¨Ø¯Ù†ÙŠ</label>
          <label id="label-activity-en" for="activity" style="display:none;">Physical Activity Level</label>
          <select id="activity" required>
            <option value="" disabled selected>-- Ø§Ø®ØªØ± --</option>
            <option value="inactive" id="activity-inactive-ar" style="display:block;">Ø®Ø§Ù…Ù„</option>
            <option value="inactive" id="activity-inactive-en" style="display:none;">Inactive</option>
            <option value="moderate" id="activity-moderate-ar" style="display:block;">Ù…ØªÙˆØ³Ø·</option>
            <option value="moderate" id="activity-moderate-en" style="display:none;">Moderate</option>
            <option value="active" id="activity-active-ar" style="display:block;">Ù†Ø´ÙŠØ·</option>
            <option value="active" id="activity-active-en" style="display:none;">Active</option>
          </select>
        </div>
        <div class="form-row">
          <label id="label-bp-ar" for="bp" style="display:block;">Ø¶ØºØ· Ø§Ù„Ø¯Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <label id="label-bp-en" for="bp" style="display:none;">Blood Pressure (optional)</label>
          <input type="text" id="bp" placeholder="120/80">
        </div>
        <div class="form-row">
          <label id="label-glucose-ar" for="glucose" style="display:block;">Ø³ÙƒØ± ØµØ§ÙŠÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <label id="label-glucose-en" for="glucose" style="display:none;">Fasting Glucose (optional)</label>
          <input type="number" id="glucose" min="50" max="400" step="0.1">
        </div>
        <div class="form-row">
          <label id="label-note-ar" for="note" style="display:block;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <label id="label-note-en" for="note" style="display:none;">Notes (optional)</label>
          <textarea id="note" rows="2"></textarea>
        </div>
        <div style="text-align:center;margin-top:18px;">
          <button type="submit" id="submit-ar" style="display:block;">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          <button type="submit" id="submit-en" style="display:none;">Save</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    // Ø§Ù„Ù„ØºØ©
    let lang = localStorage.getItem('hl_language') || 'ar';
    function setLang(newLang) {
      lang = newLang;
      localStorage.setItem('hl_language', lang);
      ['ar','en'].forEach(l=>{
        document.querySelectorAll(`[id$="-${l}"]`).forEach(el=>el.style.display=(l===lang?'block':'none'));
        document.body.dir = (lang === 'ar') ? 'rtl' : 'ltr';
      });
      if(document.getElementById('firstMeasurementModal')) setLangModal(lang);
    }
    function setLangModal(newLang) {
      ['ar','en'].forEach(l=>{
        document.querySelectorAll(`#firstMeasurementModal [id$="-${l}"]`).forEach(el=>el.style.display=(l===lang?'block':'none'));
        document.querySelectorAll(`#firstMeasurementModal [id^="activity-"][id$="-"+l]`).forEach(el=>el.style.display=(l===lang?'block':'none'));
      });
      document.querySelectorAll('.lang-btn').forEach(btn=>btn.classList.remove('active'));
      document.getElementById('modal-lang-' + lang).classList.add('active');
    }
    document.getElementById('lang-ar').onclick = ()=>setLang('ar');
    document.getElementById('lang-en').onclick = ()=>setLang('en');
    document.getElementById('modal-lang-ar').onclick = ()=>setLangModal('ar');
    document.getElementById('modal-lang-en').onclick = ()=>setLangModal('en');

    // ... Ø¯ÙˆØ§Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙƒÙ…Ø§ Ù‡ÙŠ

    // ØªØ±Ø¬Ù…Ø© Ø¨Ø¹Ø¶ Ø§Ù„Ù†ØµÙˆØµ
    function txt(key) {
      let dict = {
        summary_loading: {ar:"Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...",en:"Loading..."},
        summary_no_data: {ar:"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚ÙŠØ§Ø³Ø§ØªØŒ Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠØ§Ø³Ø§ØªÙƒ Ø£ÙˆÙ„Ø§Ù‹.",en:"No measurements found. Please enter your first data."},
        summary_login: {ar:"Ø¨Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.",en:"Please sign in first."},
        notes_title: {ar:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©:",en:"General notes:"},
        notes_good: {ar:"Ù…Ø¤Ø´Ø±Ø§ØªÙƒ Ø§Ù„ØµØ­ÙŠØ© Ø¬ÙŠØ¯Ø©ØŒ Ø­Ø§ÙØ¸ Ø¹Ù„ÙŠÙ‡Ø§!",en:"Your health indicators are good, keep it up!"},
        btn_update: {ar:"ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª",en:"Update Measurements"},
        modal_title: {ar:"Ø³Ø¬Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„ØµØ­ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰",en:"Register your first health data"}
      };
      return dict[key] ? dict[key][lang] : key;
    }

    // Firebase Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    const firebaseConfig = {
      apiKey: "AIzaSyCdUHldUu83kfgc_qUn-h5rZ8xTl2rhNjA",
      authDomain: "healthy-wealthy-app.firebaseapp.com",
      projectId: "healthy-wealthy-app",
      storageBucket: "healthy-wealthy-app.appspot.com",
      messagingSenderId: "182436316225",
      appId: "1:182436316225:web:5cfd34f879204b12ebf2c0"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ... Ø¯ÙˆØ§Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙƒÙ…Ø§ Ù‡ÙŠ

    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    auth.onAuthStateChanged(function(user) {
      if (user) {
        db.collection('users')
          .doc(user.uid)
          .collection('measurements')
          .orderBy('date','desc')
          .get()
          .then(snapshot=>{
            if(snapshot.empty){
              document.getElementById('firstMeasurementModal').style.display = "flex";
              document.getElementById('lastMeasurements').innerHTML = txt("summary_no_data");
              document.getElementById('cards').innerHTML = '';
              document.getElementById('notes').innerHTML = '';
              return;
            }
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ø­Ø¯Ø« Ù‚ÙŠÙ…Ø© Ù„ÙƒÙ„ Ù‚ÙŠØ§Ø³
            let latest = {};
            let fields = ['weight','height','waist','hip','age','gender','activity','bp','glucose'];
            for(let f of fields){
              for(let doc of snapshot.docs){
                let val = doc.data()[f];
                if(val!==undefined && val!==null && val!==''){
                  latest[f] = val;
                  break;
                }
              }
            }
            // ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³
            let units = {
              weightUnit: 'ÙƒØ¬Ù…',
              heightUnit: 'Ø³Ù…',
              waistUnit: 'Ø³Ù…',
              hipUnit: 'Ø³Ù…'
            };
            for(let u in units){
              for(let doc of snapshot.docs){
                let val = doc.data()[u];
                if(val){
                  units[u] = val;
                  break;
                }
              }
            }
            let m = {...latest, ...units};
            // Ù…Ù„Ø®Øµ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª
            let summary = (lang==='ar') ? `
              <strong>Ø§Ù„ÙˆØ²Ù†:</strong> ${m.weight} ${m.weightUnit} &nbsp;
              <strong>Ø§Ù„Ø·ÙˆÙ„:</strong> ${m.height} ${m.heightUnit} &nbsp;
              <strong>Ø§Ù„Ø¹Ù…Ø±:</strong> ${m.age || '-'} &nbsp;
              <strong>Ø§Ù„Ø¬Ù†Ø³:</strong> ${m.gender==='male'?'Ø°ÙƒØ±':'Ø£Ù†Ø«Ù‰'} &nbsp;
              <strong>Ø§Ù„Ø®ØµØ±:</strong> ${m.waist} ${m.waistUnit} &nbsp;
              <strong>Ø§Ù„ÙˆØ±Ùƒ:</strong> ${m.hip||'-'} ${m.hipUnit} &nbsp;
              <strong>Ø§Ù„Ù†Ø´Ø§Ø·:</strong> ${activityTxt(m.activity)} &nbsp;
              <strong>Ø¶ØºØ· Ø§Ù„Ø¯Ù…:</strong> ${m.bp||'-'} &nbsp;
              <strong>Ø³ÙƒØ± ØµØ§ÙŠÙ…:</strong> ${m.glucose||'-'}
            ` : `
              <strong>Weight:</strong> ${m.weight} ${m.weightUnit} &nbsp;
              <strong>Height:</strong> ${m.height} ${m.heightUnit} &nbsp;
              <strong>Age:</strong> ${m.age || '-'} &nbsp;
              <strong>Gender:</strong> ${m.gender==='male'?'Male':'Female'} &nbsp;
              <strong>Waist:</strong> ${m.waist} ${m.waistUnit} &nbsp;
              <strong>Hip:</strong> ${m.hip||'-'} ${m.hipUnit} &nbsp;
              <strong>Activity:</strong> ${activityTxt(m.activity)} &nbsp;
              <strong>Blood Pressure:</strong> ${m.bp||'-'} &nbsp;
              <strong>Fasting Glucose:</strong> ${m.glucose||'-'}
            `;
            document.getElementById('lastMeasurements').innerHTML = summary;

            let weight = parseFloat(m.weight)||0;
            let height = parseFloat(m.height)||0;
            let age = parseFloat(m.age)||0;
            let waist = parseFloat(m.waist)||0;
            let hip = parseFloat(m.hip)||0;
            let gender = m.gender||'male';
            let activity = m.activity||'inactive';
            let bp = m.bp||'';
            let glucose = m.glucose||'';

            let bmi = calcBMI(weight,height);
            let bmiN = bmiNote(bmi,lang);
            let bmr = calcBMR(weight,height,age,gender);
            let factor = activityFactor(activity);
            let calories = Math.round(bmr*factor);
            let calorieN = calorieNote(calories,lang);
            let waistHip = (waist && hip)?calcWaistHip(waist,hip):"-";
            let waistHipN = (waistHip!=="-")?waistHipNote(waistHip,gender,lang):{txt:"ØºÙŠØ± Ù…Ø­Ø¯Ø¯",cls:""};
            let waistHeight = (waist && height)?calcWaistHeight(waist,height):"-";
            let waistHeightN = (waistHeight!=="-")?waistHeightNote(waistHeight,lang):{txt:"ØºÙŠØ± Ù…Ø­Ø¯Ø¯",cls:""};
            let bpN = bpNote(bp,lang);
            let glucoseN = glucoseNote(glucose,lang);
            let bodyFat = calcBodyFat(gender,waist,weight);
            let bodyFatN = bodyFatNote(bodyFat,gender,lang);

            // Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
            let cards = (lang==='ar') ? `
              <div class="card">
                <div class="card-title">Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªÙ„Ø© BMI</div>
                <div class="card-value">${bmi}</div>
                <div class="card-note ${bmiN.cls}">${bmiN.txt}</div>
              </div>
              <div class="card">
                <div class="card-title">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø±Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ BMR</div>
                <div class="card-value">${bmr} Ø³Ø¹Ø± Ø­Ø±Ø§Ø±ÙŠ</div>
                <div class="card-note good">Ù…Ø¹Ø¯Ù„ Ø·Ø¨ÙŠØ¹ÙŠ</div>
              </div>
              <div class="card">
                <div class="card-title">Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹</div>
                <div class="card-value">${calories} Ø³Ø¹Ø± Ø­Ø±Ø§Ø±ÙŠ</div>
                <div class="card-note ${calorieN.cls}">${calorieN.txt}</div>
              </div>
              <div class="card">
                <div class="card-title">Waist/Hip Ratio</div>
                <div class="card-value">${waistHip}</div>
                <div class="card-note ${waistHipN.cls}">${waistHipN.txt}</div>
              </div>
              <div class="card">
                <div class="card-title">Waist/Height Ratio</div>
                <div class="card-value">${waistHeight}</div>
                <div class="card-note ${waistHeightN.cls}">${waistHeightN.txt}</div>
              </div>
              <div class="card">
                <div class="card-title">Blood Pressure</div>
                <div class="card-value">${bp}</div>
                <div class="card-note ${bpN.cls}">${bpN.txt}</div>
              </div>
              <div class="card">
                <div class="card-title">Ø³ÙƒØ± ØµØ§ÙŠÙ…</div>
                <div class="card-value">${glucose}</div>
                <div class="card-note ${glucoseN.cls}">${glucoseN.txt}</div>
              </div>
              <div class="card">
                <div class="card-title">Ù†Ø³Ø¨Ø© Ø¯Ù‡ÙˆÙ† Ø§Ù„Ø¬Ø³Ù…</div>
                <div class="card-value">${bodyFat}%</div>
                <div class="card-note ${bodyFatN.cls}">${bodyFatN.txt}</div>
              </div>
              ${getSleepCard()}
            ` : `
              <div class="card">
                <div class="card-title">BMI Index</div>
                <div class="card-value">${bmi}</div>
                <div class="card-note ${bmiN.cls}">${bmiN.txt}</div>
              </div>
              <div class="card">
                <div class="card-title">Basic Metabolic Rate BMR</div>
                <div class="card-value">${bmr} kcal</div>
                <div class="card-note good">Normal rate</div>
              </div>
              <div class="card">
                <div class="card-title">Required daily calories</div>
                <div class="card-value">${calories} kcal</div>
                <div class="card-note ${calorieN.cls}">${calorieN.txt}</div>
              </div>
              <div class="card">
                <div class="card-title">Waist/Hip Ratio</div>
                <div class="card-value">${waistHip}</div>
                <div class="card-note ${waistHipN.cls}">${waistHipN.txt}</div>
              </div>
              <div class="card">
                <div class="card-title">Waist/Height Ratio</div>
                <div class="card-value">${waistHeight}</div>
                <div class="card-note ${waistHeightN.cls}">${waistHeightN.txt}</div>
              </div>
              <div class="card">
                <div class="card-title">Blood Pressure</div>
                <div class="card-value">${bp}</div>
                <div class="card-note ${bpN.cls}">${bpN.txt}</div>
              </div>
              <div class="card">
                <div class="card-title">Fasting Glucose</div>
                <div class="card-value">${glucose}</div>
                <div class="card-note ${glucoseN.cls}">${glucoseN.txt}</div>
              </div>
              <div class="card">
                <div class="card-title">Body Fat Percentage</div>
                <div class="card-value">${bodyFat}%</div>
                <div class="card-note ${bodyFatN.cls}">${bodyFatN.txt}</div>
              </div>
              ${getSleepCard()}
            `;
            document.getElementById('cards').innerHTML = cards;

            // Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©
            let notesArr = allNotes({
              activity, bmi, bpNote:bpN, glucoseNote:glucoseN, waistHipNote:waistHipN
            }, lang);
            let notesHtml = `<strong>${txt("notes_title")}</strong><ul>`;
            notesArr.forEach(n=>notesHtml+=`<li>${n}</li>`);
            notesHtml += `</ul>`;
            document.getElementById('notes').innerHTML = notesHtml;
          });
      } else {
        document.getElementById('lastMeasurements').innerHTML = txt("summary_login");
        document.getElementById('cards').innerHTML = '';
        document.getElementById('notes').innerHTML = '';
      }
    });

    // Ø­ÙØ¸ Ø£ÙˆÙ„ Ù‚ÙŠØ§Ø³
    document.getElementById('firstMeasurementForm').onsubmit = function(e){
      e.preventDefault();
      let dob = document.getElementById('dob').value;
      let age = dob ? Math.floor((new Date() - new Date(dob)) / (365.25 * 24 * 60 * 60 * 1000)) : '';
      let measurement = {
        date: new Date().toISOString(),
        weight: document.getElementById('weight').value,
        weightUnit: document.getElementById('weight-unit').value,
        height: document.getElementById('height').value,
        heightUnit: document.getElementById('height-unit').value,
        age: age,
        dob: dob,
        gender: document.querySelector('[name="gender"]:checked').value,
        waist: document.getElementById('waist').value,
        waistUnit: document.getElementById('waist-unit').value,
        hip: document.getElementById('hip').value,
        hipUnit: document.getElementById('hip-unit').value,
        activity: document.getElementById('activity').value,
        bp: document.getElementById('bp').value,
        glucose: document.getElementById('glucose').value,
        note: document.getElementById('note').value
      };
      auth.onAuthStateChanged(function(user){
        db.collection('users').doc(user.uid).collection('measurements').add(measurement)
        .then(function() {
          alert(lang==='ar'?'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³ Ø¨Ù†Ø¬Ø§Ø­':'Saved successfully');
          document.getElementById('firstMeasurementModal').style.display='none';
          location.reload();
        })
        .catch(function(error) {
          alert(lang==='ar' ? 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: ' + error.message : 'Error while saving: ' + error.message);
        });
      });
    }

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ø¶Ø¨Ø· Ø§Ù„Ù„ØºØ©
    window.onload = function() {
      setLang(lang);
    };

    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù„Ø¯Ø¹Ù… Ø§Ù„ØªØ±Ø¬Ù…Ø©...
    function bmiNote(bmi,lang) {
      if (bmi < 18.5) return {txt:(lang==='ar'?"Ù†Ø­Ø§ÙØ© - ØªØ­ØªØ§Ø¬ Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆØ²Ù†":"Underweight - need to gain weight"),cls:"warn"};
      if (bmi < 25) return {txt:(lang==='ar'?"ÙˆØ²Ù† Ø·Ø¨ÙŠØ¹ÙŠ - Ø­Ø§ÙØ¸ Ø¹Ù„ÙŠÙ‡":"Normal weight - keep it up"),cls:"good"};
      if (bmi < 30) return {txt:(lang==='ar'?"Ø²ÙŠØ§Ø¯Ø© ÙˆØ²Ù† - ÙŠÙØ¶Ù„ ÙÙ‚Ø¯Ø§Ù† Ø¨Ø¹Ø¶ Ø§Ù„ÙˆØ²Ù†":"Overweight - try to lose some weight"),cls:"warn"};
      return {txt:(lang==='ar'?"Ø³Ù…Ù†Ø© - Ø§Ù†ØªØ¨Ù‡ Ù„ØµØ­ØªÙƒ ÙˆÙ‚Ù„Ù„ ÙˆØ²Ù†Ùƒ":"Obesity - take care and lose weight"),cls:""};
    }
    function calorieNote(cal,lang) {
      return {txt:(lang==='ar'?"Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ. Ù„ÙÙ‚Ø¯Ø§Ù† 0.5ÙƒØ¬Ù…/Ø£Ø³Ø¨ÙˆØ¹ Ù‚Ù„Ù„ 500 Ø³Ø¹Ø±.":"To maintain current weight. To lose 0.5kg/week, reduce 500 kcal."),cls:"warn"};
    }
    function activityTxt(val) {
      if(lang==='ar') {
        if(val==='inactive') return 'Ø®Ø§Ù…Ù„';
        if(val==='moderate') return 'Ù…ØªÙˆØ³Ø·';
        if(val==='active') return 'Ù†Ø´ÙŠØ·';
      } else {
        if(val==='inactive') return 'Inactive';
        if(val==='moderate') return 'Moderate';
        if(val==='active') return 'Active';
      }
      return '-';
    }
    function waistHipNote(ratio,gender,lang) {
      if(gender==="male" && ratio>0.9) return {txt:(lang==='ar'?"Ù…Ø±ØªÙØ¹ - Ø®Ø·Ø± Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù†Ø³ÙˆÙ„ÙŠÙ†":"High - risk of insulin resistance"),cls:""};
      if(gender==="female" && ratio>0.85) return {txt:(lang==='ar'?"Ù…Ø±ØªÙØ¹ - Ø®Ø·Ø± Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù†Ø³ÙˆÙ„ÙŠÙ†":"High - risk of insulin resistance"),cls:""};
      return {txt:(lang==='ar'?"Ø·Ø¨ÙŠØ¹ÙŠ":"Normal"),cls:"good"};
    }
    function waistHeightNote(ratio,lang) {
      if(ratio>0.5) return {txt:(lang==='ar'?"Ù…Ø±ØªÙØ¹ - Ø³Ù…Ù†Ø© Ø¨Ø·Ù† ÙˆØ®Ø·Ø± Ù‚Ù„Ø¨":"High - abdominal obesity & heart risk"),cls:""};
      return {txt:(lang==='ar'?"Ø·Ø¨ÙŠØ¹ÙŠ":"Normal"),cls:"good"};
    }
    function bpNote(bp,lang) {
      if(!bp) return {txt:(lang==='ar'?"ØºÙŠØ± Ù…Ø­Ø¯Ø¯":"Not set"),cls:""};
      let parts = bp.split("/");
      if(parts.length<2) return {txt:(lang==='ar'?"ØºÙŠØ± Ù…Ø­Ø¯Ø¯":"Not set"),cls:""};
      let sys = parseInt(parts[0]), dia = parseInt(parts[1]);
      if(sys<120 && dia<80) return {txt:(lang==='ar'?"Ø·Ø¨ÙŠØ¹ÙŠ":"Normal"),cls:"good"};
      if(sys<140 && dia<90) return {txt:(lang==='ar'?"Ù…Ø±ØªÙØ¹ Ù‚Ù„ÙŠÙ„Ø§Ù‹":"Slightly high"),cls:"warn"};
      return {txt:(lang==='ar'?"Ù…Ø±ØªÙØ¹ - Ø±Ø§Ø¬Ø¹ Ø·Ø¨ÙŠØ¨Ùƒ":"High - consult your doctor"),cls:""};
    }
    function glucoseNote(glucose,lang) {
      if(!glucose) return {txt:(lang==='ar'?"ØºÙŠØ± Ù…Ø­Ø¯Ø¯":"Not set"),cls:""};
      glucose = parseFloat(glucose);
      if(glucose < 100) return {txt:(lang==='ar'?"Ø·Ø¨ÙŠØ¹ÙŠ":"Normal"),cls:"good"};
      if(glucose < 126) return {txt:(lang==='ar'?"Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø³ÙƒØ±ÙŠ - ÙŠÙ†ØµØ­ Ø¨Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø³ØªÙ…Ø±Ø©":"Pre-diabetes - continuous monitoring advised"),cls:"warn"};
      return {txt:(lang==='ar'?"Ù…Ø±ØªÙØ¹ - Ø±Ø§Ø¬Ø¹ Ø·Ø¨ÙŠØ¨Ùƒ":"High - consult your doctor"),cls:""};
    }
    function bodyFatNote(bf,gender,lang) {
      if(!bf||isNaN(bf)) return {txt:(lang==='ar'?"ØºÙŠØ± Ù…Ø­Ø¯Ø¯":"Not set"),cls:""};
      bf = parseFloat(bf);
      if(gender==="male") {
        if(bf<15) return {txt:(lang==='ar'?"Ø·Ø¨ÙŠØ¹ÙŠ":"Normal"),cls:"good"};
        if(bf<25) return {txt:(lang==='ar'?"Ù…Ø±ØªÙØ¹ Ù‚Ù„ÙŠÙ„Ø§Ù‹":"Slightly high"),cls:"warn"};
        return {txt:(lang==='ar'?"Ù…Ø±ØªÙØ¹ - Ø§Ù†ØªØ¨Ù‡ Ù„Ù†Ø¸Ø§Ù…Ùƒ":"High - watch your diet"),cls:""};
      } else {
        if(bf<22) return {txt:(lang==='ar'?"Ø·Ø¨ÙŠØ¹ÙŠ":"Normal"),cls:"good"};
        if(bf<32) return {txt:(lang==='ar'?"Ù…Ø±ØªÙØ¹ Ù‚Ù„ÙŠÙ„Ø§Ù‹":"Slightly high"),cls:"warn"};
        return {txt:(lang==='ar'?"Ù…Ø±ØªÙØ¹ - Ø§Ù†ØªØ¨Ù‡ÙŠ Ù„Ù†Ø¸Ø§Ù…Ùƒ":"High - watch your diet"),cls:""};
      }
    }
    function allNotes(data,lang) {
      let arr = [];
      if(data.activity==='inactive') arr.push(lang==='ar'?"Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¨Ø¯Ù†ÙŠ Ù‚Ù„ÙŠÙ„ØŒ ÙŠÙ†ØµØ­ Ø¨Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø±ÙƒØ©.":"Physical activity is low, try to move more.");
      if(data.bmi>=25) arr.push(lang==='ar'?"Ø§Ù„ÙˆØ²Ù† ÙÙˆÙ‚ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØŒ ÙŠÙØ¶Ù„ Ø§ØªØ¨Ø§Ø¹ Ù†Ø¸Ø§Ù… ØºØ°Ø§Ø¦ÙŠ Ù…Ù†Ø§Ø³Ø¨.":"Weight is above normal, consider a healthy diet.");
      if(data.bpNote&&data.bpNote.cls==="warn") arr.push(lang==='ar'?"Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø¨Ø­Ø§Ø¬Ø© Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¯ÙˆØ±ÙŠØ©.":"Blood pressure needs regular monitoring.");
      if(data.glucoseNote&&data.glucoseNote.cls!=="good") arr.push(lang==='ar'?"ÙŠÙ†ØµØ­ Ø¨Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³ÙƒØ± Ø£Ùˆ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨.":"Monitor glucose or consult a doctor.");
      if(data.waistHipNote&&data.waistHipNote.cls!=="good") arr.push(lang==='ar'?"Ø®Ø·Ø± Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø¥Ù†Ø³ÙˆÙ„ÙŠÙ† ÙˆØ³Ù…Ù†Ø© Ù…Ø±ÙƒØ²ÙŠØ©.":"Risk of insulin resistance and central obesity.");
      if(arr.length===0) arr.push(txt("notes_good"));
      return arr;
    }
    function calcBMI(weight, height) {
      let h = height/100;
      let bmi = weight / (h*h);
      return Math.round(bmi*10)/10;
    }
    function calcBMR(weight,height,age,gender) {
      if(gender==="male") return Math.round(10*weight + 6.25*height - 5*age + 5);
      else return Math.round(10*weight + 6.25*height - 5*age - 161);
    }
    function activityFactor(activity) {
      if(activity==='inactive') return 1.2;
      if(activity==='moderate') return 1.375;
      if(activity==='active') return 1.55;
      return 1.2;
    }
    function calcWaistHip(waist,hip) {
      if(!waist||!hip) return "-";
      return Math.round((waist/hip)*100)/100;
    }
    function calcWaistHeight(waist,height) {
      if(!waist||!height) return "-";
      return Math.round((waist/height)*100)/100;
    }
    function calcBodyFat(gender,waist,weight) {
      if(!waist||!weight) return "-";
      let bf = (gender==="male") ? (0.74*waist - 0.082*weight - 34.89) : (0.74*waist - 0.082*weight - 44.74);
      bf = Math.round(bf);
      if(bf<1) bf=waist;
      return bf;
    }

    // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø±Øª Ø§Ù„Ù†ÙˆÙ…
    function getSleepCard() {
      const sleepData = JSON.parse(localStorage.getItem('sleepAssessment') || 'null');
      
      if (!sleepData) {
        return lang === 'ar' ? `
          <div class="card" style="border: 2px dashed #9C27B0; background: #F3E5F5;">
            <div class="card-title" style="color: #9C27B0;">ğŸŒ™ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†ÙˆÙ…</div>
            <div class="card-value" style="color: #9C27B0;">ØºÙŠØ± Ù…ÙƒØªÙ…Ù„</div>
            <div class="card-note" style="color: #9C27B0;">Ù‚Ù… Ø¨Ø¥Ø¬Ø±Ø§Ø¡ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†ÙˆÙ… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„</div>
            <button class="btn" onclick="window.location.href='../sleep/assessment.html'" style="background: #9C27B0; margin-top: 10px;">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
          </div>
        ` : `
          <div class="card" style="border: 2px dashed #9C27B0; background: #F3E5F5;">
            <div class="card-title" style="color: #9C27B0;">ğŸŒ™ Sleep Assessment</div>
            <div class="card-value" style="color: #9C27B0;">Not Completed</div>
            <div class="card-note" style="color: #9C27B0;">Take the sleep assessment for comprehensive analysis</div>
            <button class="btn" onclick="window.location.href='sleep/assessment.html'" style="background: #9C27B0; margin-top: 10px;">Start Assessment</button>
          </div>
        `;
      }
      
      const score = sleepData.score || 0;
      const lastAssessment = new Date(sleepData.date).toLocaleDateString('ar-EG');
      
      let scoreClass = 'good';
      let scoreText = lang === 'ar' ? 'Ù…Ù…ØªØ§Ø²' : 'Excellent';
      
      if (score < 40) {
        scoreClass = 'card-note';
        scoreText = lang === 'ar' ? 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†' : 'Needs Improvement';
      } else if (score < 70) {
        scoreClass = 'warn';
        scoreText = lang === 'ar' ? 'Ù…ØªÙˆØ³Ø·' : 'Average';
      }
      
      return lang === 'ar' ? `
        <div class="card" style="border-left: 4px solid #9C27B0;">
          <div class="card-title" style="color: #9C27B0;">ğŸŒ™ Ø¬ÙˆØ¯Ø© Ø§Ù„Ù†ÙˆÙ…</div>
          <div class="card-value" style="color: #9C27B0;">${score}/100</div>
          <div class="card-note ${scoreClass}">${scoreText}</div>
          <div style="font-size: 0.85em; color: #666; margin-top: 5px;">Ø¢Ø®Ø± ØªÙ‚ÙŠÙŠÙ…: ${lastAssessment}</div>
          <button class="btn" onclick="window.location.href='sleep/index.html'" style="background: #9C27B0; margin-top: 8px; font-size: 0.9em; padding: 6px 16px;">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
        </div>
      ` : `
        <div class="card" style="border-left: 4px solid #9C27B0;">
          <div class="card-title" style="color: #9C27B0;">ğŸŒ™ Sleep Quality</div>
          <div class="card-value" style="color: #9C27B0;">${score}/100</div>
          <div class="card-note ${scoreClass}">${scoreText}</div>
          <div style="font-size: 0.85em; color: #666; margin-top: 5px;">Last assessment: ${lastAssessment}</div>
          <button class="btn" onclick="window.location.href='sleep/index.html'" style="background: #9C27B0; margin-top: 8px; font-size: 0.9em; padding: 6px 16px;">View Details</button>
        </div>
      `;
    }

  </script>
</body>
// ØªØ³Ø¬ÙŠÙ„ Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js')
            .then(function(registration) {
                console.log('SW registered: ', registration);
            })
            .catch(function(registrationError) {
                console.log('SW registration failed: ', registrationError);
            });
    });
}
</body>
</html>