/**
 * ููู ุงููุธุงุฆู ุงููุดุชุฑูุฉ ุจูู ุฌููุน ุฃุฌุฒุงุก ุงูุชุทุจูู
 */

// ุงุณุชูุฑุงุฏ ููู ุงูุฅุนุฏุงุฏุงุช
document.write('<script src="config/app-config.js"></script>');

/**
 * ูุธุงุฆู ุฅุฏุงุฑุฉ ุงููุบุฉ
 */
const languageService = {
    // ุงูุญุตูู ุนูู ุงููุบุฉ ุงูุญุงููุฉ
    getCurrentLanguage: function() {
        return localStorage.getItem(APP_CONFIG.storage.language) || APP_CONFIG.languages.ar;
    },
    
    // ุชุนููู ุงููุบุฉ
    setLanguage: function(lang) {
        if (lang === APP_CONFIG.languages.ar || lang === APP_CONFIG.languages.en) {
            localStorage.setItem(APP_CONFIG.storage.language, lang);
            return true;
        }
        return false;
    },
    
    // ุชุจุฏูู ุงููุบุฉ
    toggleLanguage: function() {
        const currentLang = this.getCurrentLanguage();
        const newLang = currentLang === APP_CONFIG.languages.ar ? APP_CONFIG.languages.en : APP_CONFIG.languages.ar;
        this.setLanguage(newLang);
        return newLang;
    },
    
    // ุชุทุจูู ุฅุนุฏุงุฏุงุช ุงููุบุฉ ุนูู ุงูุตูุญุฉ
    applyLanguageSettings: function() {
        const currentLang = this.getCurrentLanguage();
        document.documentElement.lang = currentLang;
        document.body.dir = currentLang === APP_CONFIG.languages.ar ? 'rtl' : 'ltr';
        return currentLang;
    }
};

/**
 * ูุธุงุฆู ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏู
 */
const userService = {
    // ุชุณุฌูู ุฎุฑูุฌ ุงููุณุชุฎุฏู
    logout: function() {
        console.log('๐ช ุชุณุฌูู ุฎุฑูุฌ ุงููุณุชุฎุฏู...');
        
        try {
            // ุงุณุชุฎุฏุงู Firebase ูุจุงุดุฑุฉ ูุชุฌูุจ ุงููุดุงูู
            firebase.auth().signOut()
                .then(() => {
                    console.log('โ ุชู ุชุณุฌูู ุงูุฎุฑูุฌ ุจูุฌุงุญ ูู Firebase');
                    
                    // ุนุฏู ุญุฐู ุงููุบุฉ ุงูููุถูุฉ ุนูุฏ ุชุณุฌูู ุงูุฎุฑูุฌ
                    // localStorage.removeItem(APP_CONFIG.storage.language);
                    
                    // ุชูุฌูู ุงููุณุชุฎุฏู ููุตูุญุฉ ุงูุฑุฆูุณูุฉ
                    window.location.href = APP_CONFIG.paths.pages.index;
                })
                .catch(error => {
                    console.error('โ ุฎุทุฃ ูู ุชุณุฌูู ุงูุฎุฑูุฌ ูู Firebase:', error);
                    // ุญุชู ูู ูุดู ุงูุฎุฑูุฌ ูู Firebaseุ ูููู ุจุงูุฎุฑูุฌ ูุญููุงู
                    window.location.href = APP_CONFIG.paths.pages.index;
                });
        } catch (error) {
            console.error('โ ุฎุทุฃ ุฃุซูุงุก ูุญุงููุฉ ุชุณุฌูู ุงูุฎุฑูุฌ:', error);
            // ุฅุฐุง ูู ุชูู ุฎุฏูุฉ Firebase ูุชุงุญุฉ
            window.location.href = APP_CONFIG.paths.pages.index;
        }
    },
    
    // ุงูุญุตูู ุนูู ุจูุงูุงุช ุงููุณุชุฎุฏู (ูุน ุฏุนู Firebase)
    getUserData: async function(collection, document) {
        if (window.firebaseService) {
            return await firebaseService.data.get(collection, document);
        } else {
            // Fallback ููุชุฎุฒูู ุงููุญูู
            const dataKey = `${APP_CONFIG.storage.userData}_${collection}_${document}`;
            const userData = localStorage.getItem(dataKey);
            return userData ? JSON.parse(userData) : null;
        }
    },
    
    // ุญูุธ ุจูุงูุงุช ุงููุณุชุฎุฏู (ูุน ุฏุนู Firebase)
    saveUserData: async function(collection, document, data) {
        if (window.firebaseService) {
            return await firebaseService.data.save(collection, document, data);
        } else {
            // Fallback ููุชุฎุฒูู ุงููุญูู
            const dataKey = `${APP_CONFIG.storage.userData}_${collection}_${document}`;
            localStorage.setItem(dataKey, JSON.stringify(data));
            return true;
        }
    },
    
    // ุงูุญุตูู ุนูู ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุนุงูุฉ (ููุชูุงูู ูุน ุงูููุฏ ุงููุฏูู)
    getProfileData: function() {
        const userData = localStorage.getItem(APP_CONFIG.storage.userData);
        return userData ? JSON.parse(userData) : null;
    },
    
    // ุญูุธ ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุนุงูุฉ (ููุชูุงูู ูุน ุงูููุฏ ุงููุฏูู)
    saveProfileData: function(data) {
        localStorage.setItem(APP_CONFIG.storage.userData, JSON.stringify(data));
        // ุฃูุถุงู ุญูุธ ูู Firebase ุฅุฐุง ูุงู ูุชุงุญุงู
        if (window.firebaseService) {
            firebaseService.data.save(APP_CONFIG.firebase.collections.profile, 'userData', data);
        }
    },
    
    // ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุฏ ุฃุฏุฎู ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ ุฃู ุชุฎุทุงูุง
    hasBasicInfo: async function() {
        if (window.firebaseService) {
            const data = await firebaseService.data.get(
                APP_CONFIG.firebase.collections.medical,
                APP_CONFIG.firebase.documents.basicInfo
            );
            // ุฅุฐุง ูุงู ููุงู ุฎุงุตูุฉ skipped=true ุงุนุชุจุฑ ุงูุจูุงูุงุช ุบูุฑ ููุชููุฉ
            if (data && data.skipped === true) return false;
            // ุชุญูู ูู ุฌููุน ุงูุญููู ุงููุทููุจุฉ
            if (data && data.fullName && data.birthDate && data.height && data.weight && data.waist && data.bloodType) {
                return true;
            }
            return false;
        } else {
            const basicInfoStr = localStorage.getItem(APP_CONFIG.storage.basicInfo);
            if (basicInfoStr !== null) {
                try {
                    const basicInfo = JSON.parse(basicInfoStr);
                    if (basicInfo.skipped === true) {
                        return false;
                    }
                    if (basicInfo.fullName && basicInfo.birthDate && basicInfo.height && basicInfo.weight && basicInfo.waist && basicInfo.bloodType) {
                        return true;
                    }
                    return false;
                } catch (e) {
                    return false;
                }
            }
            return false;
        }
    },
    
    // ุงูุญุตูู ุนูู ูุนุฑู ุงููุณุชุฎุฏู ุงูุญุงูู
    getCurrentUserId: function() {
        if (window.firebaseService) {
            return firebaseService.getUserId();
        } else {
            let userId = localStorage.getItem(APP_CONFIG.storage.userId);
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem(APP_CONFIG.storage.userId, userId);
            }
            return userId;
        }
    }
};

/**
 * ูุธุงุฆู ูุงุฌูุฉ ุงููุณุชุฎุฏู ุงููุดุชุฑูุฉ
 */
const uiService = {
    // ุฅุธูุงุฑ ุชูุจูู ูููุณุชุฎุฏู
    showAlert: function(message, type = 'info', duration = 2500) {
        let alertDiv = document.createElement('div');
        alertDiv.innerText = message;
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '50%';
        alertDiv.style.left = '50%';
        alertDiv.style.transform = 'translate(-50%, -50%)';
        alertDiv.style.background = '#fff';
        alertDiv.style.padding = '24px 32px';
        alertDiv.style.borderRadius = '16px';
        alertDiv.style.boxShadow = '0 4px 24px #0002';
        alertDiv.style.zIndex = '99999';
        alertDiv.style.textAlign = 'center';
        
        // ุชุนููู ููู ุงููุต ุญุณุจ ููุน ุงูุชูุจูู
        switch (type) {
            case 'error':
                alertDiv.style.color = '#f44336';
                break;
            case 'success':
                alertDiv.style.color = '#4CAF50';
                break;
            case 'warning':
                alertDiv.style.color = '#ff9800';
                break;
            default:
                alertDiv.style.color = '#2196F3';
        }
        
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), duration);
    },
    
    // ุชุญููู ูููู ุฎุงุฑุฌู ุฅูู ุนูุตุฑ ูุนูู
    loadComponent: function(elementId, componentPath) {
        const element = document.getElementById(elementId);
        if (element) {
            fetch(componentPath)
                .then(response => response.text())
                .then(html => {
                    element.innerHTML = html;
                    // ุชูููุฐ ุฃู ุณูุฑุจุช ูู ุงููููู
                    Array.from(element.querySelectorAll('script')).forEach(oldScript => {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(attr => {
                            newScript.setAttribute(attr.name, attr.value);
                        });
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });
                })
                .catch(error => {
                    console.error("ุฎุทุฃ ูู ุชุญููู ุงููููู:", error);
                    element.innerHTML = `<p>ุฎุทุฃ ูู ุชุญููู ุงููููู</p>`;
                });
        }
    }
};

/**
 * ูุธุงุฆู ุงูุชููู ูุงูุฑูุงุจุท
 */
const navigationService = {
    // ุงูุงูุชูุงู ุฅูู ุตูุญุฉ ูุนููุฉ ูุน ุงูุญูุงุธ ุนูู ูุนูููุงุช ุงููุบุฉ
    navigateTo: function(path) {
        window.location.href = path;
    },
    
    // ุงูุญุตูู ุนูู ูุนููุงุช URL
    getUrlParams: function() {
        const params = {};
        new URLSearchParams(window.location.search).forEach((value, key) => {
            params[key] = value;
        });
        return params;
    },
    
    // ุงูุงูุชูุงู ุฅูู ูููู ูุนูู ุฏุงุฎู ุงูุชุทุจูู
    navigateToModule: function(moduleName, file) {
        const path = getModulePath(moduleName, file);
        if (path) {
            this.navigateTo(path);
        }
    }
};

// ูุดู ุงูุฎุฏูุงุช ููุงุณุชุฎุฏุงู ุงูุนุงู
window.languageService = languageService;
window.userService = userService;
window.uiService = uiService;
window.navigationService = navigationService;
window.sharedFunctions = {
    hasBasicInfo: languageService.hasBasicInfo || userService.hasBasicInfo || (typeof hasBasicInfo !== 'undefined' ? hasBasicInfo : undefined)
};