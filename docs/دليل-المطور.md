# دليل المطور لتطبيق "صحتك بالدنيا"

## مقدمة

هذا الدليل مخصص للمطورين الذين سيعملون على تطوير وصيانة تطبيق "صحتك بالدنيا". يوفر هذا الدليل نظرة عامة على هيكل التطبيق، المكونات الرئيسية، والممارسات المقترحة للتطوير. يهدف الدليل إلى تسهيل عملية فهم التطبيق وتطويره بشكل فعال.

## نظرة عامة على التطبيق

"صحتك بالدنيا" هو تطبيق شامل للرعاية الصحية الشخصية يهدف إلى مساعدة المستخدمين على:

1. متابعة حالتهم الصحية من خلال تسجيل ومراقبة القياسات الحيوية
2. إدارة الأدوية والتذكيرات
3. الاطلاع على تقارير التحاليل الطبية
4. متابعة النظام الغذائي وحساب السعرات الحرارية
5. مراقبة النشاط البدني والنوم
6. الحصول على نصائح ومعلومات صحية موثوقة
7. التواصل مع أخصائيي التغذية والصحة

## المستندات الفنية

لفهم التطبيق بشكل شامل، يرجى الاطلاع على المستندات التالية:

- **[تحليل وتوثيق التطبيق](./تحليل-وتوثيق-تطبيق-صحتك-بالدنيا.md)**: يقدم تحليلاً شاملاً للتطبيق الحالي ونقاط القوة والضعف
- **[خطة إعادة البناء والتطوير](./خطة-إعادة-بناء-وتطوير-تطبيق-صحتك-بالدنيا.md)**: تفاصيل خطة إعادة هيكلة وتطوير التطبيق
- **[هيكلة قاعدة البيانات](./هيكلة-قاعدة-البيانات.md)**: تصميم قاعدة البيانات المقترح والعلاقات بين المجموعات

## تكنولوجيات ومكتبات التطبيق

### الواجهة الأمامية (Frontend)
في إطار إعادة البناء، نستخدم التقنيات التالية:

- **إطار العمل**: Vue.js 3 + TypeScript
- **إدارة الحالة**: Pinia (بديل Vuex في Vue 3)
- **التوجيه**: Vue Router
- **واجهة المستخدم**: مكونات UI مخصصة + Tailwind CSS
- **الرسوم البيانية**: Chart.js مع Vue-Chartjs
- **النماذج والتحقق**: Vuelidate
- **الاختبارات**: Jest (اختبارات الوحدة) + Cypress (اختبارات E2E)
- **أداة البناء**: Vite

### الواجهة الخلفية (Backend)
- **خدمات الواجهة الخلفية**: Firebase
  - **المصادقة**: Firebase Authentication
  - **قاعدة البيانات**: Firestore (NoSQL)
  - **التخزين**: Firebase Storage
  - **الإشعارات**: Firebase Cloud Messaging
  - **الوظائف**: Firebase Cloud Functions (للعمليات المعقدة)

## هيكل المشروع

### هيكل المجلدات المقترح

```
healthy-app/
├── public/                # الملفات العامة
├── src/                   # كود المصدر
│   ├── assets/            # الموارد (صور، أيقونات)
│   ├── components/        # مكونات واجهة المستخدم
│   │   ├── common/        # مكونات مشتركة
│   │   ├── dashboard/     # مكونات لوحة المعلومات
│   │   ├── health/        # مكونات متعلقة بالصحة
│   │   └── ...
│   ├── views/             # صفحات التطبيق
│   ├── router/            # تكوين التوجيه
│   ├── store/             # إدارة الحالة المركزية (Pinia)
│   ├── services/          # خدمات التطبيق
│   │   ├── api.service.js # خدمة API
│   │   ├── auth.service.js# خدمة المصادقة
│   │   └── ...
│   ├── models/            # نماذج البيانات
│   ├── utils/             # أدوات وتوابع مساعدة
│   └── config/            # ملفات التكوين
├── tests/                 # اختبارات
├── docs/                  # وثائق المشروع
└── .env.*                 # ملفات البيئة
```

### المكونات الرئيسية

#### 1. نظام المصادقة
يدير تسجيل دخول المستخدمين وحسابات المستخدمين باستخدام Firebase Authentication. المكونات الرئيسية:
- `AuthService`: خدمة تتعامل مع Firebase Authentication
- `store/auth.store.js`: إدارة حالة المصادقة
- `views/auth/`: صفحات تسجيل الدخول وإنشاء الحساب

#### 2. لوحة المعلومات
تعرض نظرة عامة على المعلومات الصحية للمستخدم:
- `views/dashboard/DashboardView.vue`: الصفحة الرئيسية للوحة المعلومات
- `components/dashboard/`: المكونات المختلفة للوحة المعلومات (الكروت، المؤشرات)

#### 3. الملف الطبي
يدير المعلومات الصحية الأساسية والحالات الطبية:
- `views/medical/`: صفحات الملف الطبي
- `services/medical.service.js`: خدمة تتعامل مع بيانات الملف الطبي
- `store/medical.store.js`: إدارة حالة بيانات الملف الطبي

#### 4. القياسات الصحية
يدير تسجيل ومراقبة القياسات الحيوية:
- `views/measurements/`: صفحات القياسات
- `components/charts/`: مكونات الرسوم البيانية
- `services/measurements.service.js`: خدمة تتعامل مع بيانات القياسات

#### 5. الأدوية والتذكيرات
يدير جدولة الأدوية والتذكيرات:
- `views/medications/`: صفحات الأدوية
- `views/reminders/`: صفحات التذكيرات
- `services/reminders.service.js`: خدمة تتعامل مع التذكيرات

## الخدمات الرئيسية

### 1. FirebaseService

الخدمة الأساسية للتعامل مع Firebase، توفر طبقة تجريد للتعامل مع Firestore، Authentication، وباقي خدمات Firebase:

```typescript
// services/firebase.service.ts
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from 'firebase/auth';
import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, query, where, orderBy } from 'firebase/firestore';

export class FirebaseService {
  private app;
  private auth;
  private db;

  constructor() {
    this.app = initializeApp(firebaseConfig);
    this.auth = getAuth(this.app);
    this.db = getFirestore(this.app);
  }

  // أساليب المصادقة
  async signIn(email: string, password: string) {
    return await signInWithEmailAndPassword(this.auth, email, password);
  }

  async signUp(email: string, password: string) {
    return await createUserWithEmailAndPassword(this.auth, email, password);
  }

  // أساليب Firestore
  async getDocument(collectionName: string, docId: string) {
    const docRef = doc(this.db, collectionName, docId);
    const docSnap = await getDoc(docRef);
    return docSnap.exists() ? docSnap.data() : null;
  }

  async setDocument(collectionName: string, docId: string, data: any) {
    const docRef = doc(this.db, collectionName, docId);
    return await setDoc(docRef, data);
  }

  // المزيد من الأساليب...
}

export const firebaseService = new FirebaseService();
```

### 2. AuthService

خدمة تدير عمليات المصادقة وجلسة المستخدم:

```typescript
// services/auth.service.ts
import { firebaseService } from './firebase.service';
import { useAuthStore } from '@/store/auth.store';

export class AuthService {
  async login(email: string, password: string) {
    try {
      const userCredential = await firebaseService.signIn(email, password);
      const authStore = useAuthStore();
      authStore.setUser(userCredential.user);
      return userCredential.user;
    } catch (error) {
      console.error('خطأ في تسجيل الدخول:', error);
      throw error;
    }
  }

  async register(email: string, password: string, userData: any) {
    try {
      const userCredential = await firebaseService.signUp(email, password);
      await firebaseService.setDocument('users', userCredential.user.uid, {
        ...userData,
        createdAt: new Date()
      });
      return userCredential.user;
    } catch (error) {
      console.error('خطأ في إنشاء الحساب:', error);
      throw error;
    }
  }

  // المزيد من الأساليب...
}

export const authService = new AuthService();
```

### 3. MeasurementsService

خدمة تدير عمليات تسجيل واسترجاع القياسات:

```typescript
// services/measurements.service.ts
import { firebaseService } from './firebase.service';
import { useAuthStore } from '@/store/auth.store';

export class MeasurementsService {
  async addMeasurement(measurementData: any) {
    const authStore = useAuthStore();
    const userId = authStore.user?.uid;
    
    if (!userId) throw new Error('المستخدم غير مسجل الدخول');
    
    const data = {
      ...measurementData,
      userId,
      timestamp: new Date(),
      date: new Date().toISOString().split('T')[0] // YYYY-MM-DD
    };
    
    return await firebaseService.addDocument('measurements', data);
  }

  async getMeasurements(type: string, limit = 10) {
    const authStore = useAuthStore();
    const userId = authStore.user?.uid;
    
    if (!userId) throw new Error('المستخدم غير مسجل الدخول');
    
    return await firebaseService.queryDocuments(
      'measurements',
      [
        { field: 'userId', operator: '==', value: userId },
        { field: 'type', operator: '==', value: type }
      ],
      { field: 'timestamp', direction: 'desc' },
      limit
    );
  }

  // المزيد من الأساليب...
}

export const measurementsService = new MeasurementsService();
```

## إدارة الحالة (Pinia)

نستخدم Pinia لإدارة حالة التطبيق بشكل مركزي، مع تقسيم الحالة إلى متاجر (stores) منطقية:

### 1. متجر المصادقة (Auth Store)

```typescript
// store/auth.store.ts
import { defineStore } from 'pinia';
import { User } from 'firebase/auth';

interface AuthState {
  user: User | null;
  isAuthenticated: boolean;
  loading: boolean;
}

export const useAuthStore = defineStore('auth', {
  state: (): AuthState => ({
    user: null,
    isAuthenticated: false,
    loading: false
  }),
  
  actions: {
    setUser(user: User | null) {
      this.user = user;
      this.isAuthenticated = !!user;
    },
    
    setLoading(status: boolean) {
      this.loading = status;
    },
    
    async logout() {
      // منطق تسجيل الخروج
    }
  },
  
  getters: {
    userId: (state) => state.user?.uid,
    userEmail: (state) => state.user?.email
  }
});
```

### 2. متجر القياسات (Measurements Store)

```typescript
// store/measurements.store.ts
import { defineStore } from 'pinia';
import { measurementsService } from '@/services/measurements.service';

interface MeasurementsState {
  recentMeasurements: Record<string, any[]>;
  loading: boolean;
  error: string | null;
}

export const useMeasurementsStore = defineStore('measurements', {
  state: (): MeasurementsState => ({
    recentMeasurements: {},
    loading: false,
    error: null
  }),
  
  actions: {
    async fetchMeasurements(type: string) {
      this.loading = true;
      this.error = null;
      
      try {
        const measurements = await measurementsService.getMeasurements(type);
        this.recentMeasurements[type] = measurements;
      } catch (error: any) {
        this.error = error.message;
        console.error('خطأ في جلب القياسات:', error);
      } finally {
        this.loading = false;
      }
    },
    
    async addMeasurement(measurementData: any) {
      this.loading = true;
      this.error = null;
      
      try {
        await measurementsService.addMeasurement(measurementData);
        // تحديث البيانات المحلية
        if (this.recentMeasurements[measurementData.type]) {
          await this.fetchMeasurements(measurementData.type);
        }
      } catch (error: any) {
        this.error = error.message;
        console.error('خطأ في إضافة قياس:', error);
      } finally {
        this.loading = false;
      }
    }
  },
  
  getters: {
    getMeasurementsByType: (state) => (type: string) => {
      return state.recentMeasurements[type] || [];
    },
    
    getLatestMeasurement: (state) => (type: string) => {
      const measurements = state.recentMeasurements[type] || [];
      return measurements.length > 0 ? measurements[0] : null;
    }
  }
});
```

## مكونات واجهة المستخدم

### مثال لمكون القياسات

```vue
<!-- components/measurements/MeasurementForm.vue -->
<template>
  <div class="measurement-form">
    <h3>{{ title }}</h3>
    
    <form @submit.prevent="submitMeasurement">
      <div class="form-group">
        <label for="value">{{ label }}</label>
        <div class="input-group">
          <input
            type="number"
            id="value"
            v-model="value"
            :step="step"
            required
            :placeholder="placeholder"
          />
          <span class="unit">{{ unit }}</span>
        </div>
      </div>
      
      <div class="form-group">
        <label for="notes">ملاحظات</label>
        <textarea
          id="notes"
          v-model="notes"
          rows="2"
          placeholder="أضف أي ملاحظات هنا..."
        ></textarea>
      </div>
      
      <button type="submit" :disabled="loading">
        <span v-if="loading">جارٍ الحفظ...</span>
        <span v-else>حفظ</span>
      </button>
    </form>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue';
import { useMeasurementsStore } from '@/store/measurements.store';

const props = defineProps({
  measurementType: {
    type: String,
    required: true
  },
  title: {
    type: String,
    required: true
  },
  label: {
    type: String,
    required: true
  },
  unit: {
    type: String,
    required: true
  },
  placeholder: {
    type: String,
    default: ''
  },
  step: {
    type: String,
    default: '1'
  }
});

const value = ref('');
const notes = ref('');
const loading = ref(false);

const measurementsStore = useMeasurementsStore();

const submitMeasurement = async () => {
  if (!value.value) return;
  
  loading.value = true;
  
  try {
    await measurementsStore.addMeasurement({
      type: props.measurementType,
      value: parseFloat(value.value),
      unit: props.unit,
      notes: notes.value,
      takenAt: new Date()
    });
    
    // إعادة تعيين النموذج
    value.value = '';
    notes.value = '';
    
  } catch (error) {
    console.error('حدث خطأ أثناء حفظ القياس:', error);
  } finally {
    loading.value = false;
  }
};
</script>
```

## التوجيه (Routing)

```typescript
// router/index.ts
import { createRouter, createWebHistory, RouteRecordRaw } from 'vue-router';
import { useAuthStore } from '@/store/auth.store';
import HomeView from '@/views/HomeView.vue';
import LoginView from '@/views/auth/LoginView.vue';
import DashboardView from '@/views/dashboard/DashboardView.vue';

const routes: Array<RouteRecordRaw> = [
  {
    path: '/',
    name: 'home',
    component: HomeView
  },
  {
    path: '/login',
    name: 'login',
    component: LoginView,
    meta: { requiresGuest: true }
  },
  {
    path: '/register',
    name: 'register',
    component: () => import('@/views/auth/RegisterView.vue'),
    meta: { requiresGuest: true }
  },
  {
    path: '/dashboard',
    name: 'dashboard',
    component: DashboardView,
    meta: { requiresAuth: true }
  },
  {
    path: '/profile',
    name: 'profile',
    component: () => import('@/views/profile/ProfileView.vue'),
    meta: { requiresAuth: true }
  },
  {
    path: '/measurements',
    name: 'measurements',
    component: () => import('@/views/measurements/MeasurementsView.vue'),
    meta: { requiresAuth: true }
  },
  // المزيد من المسارات...
];

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes
});

// حماية المسارات
router.beforeEach((to, from, next) => {
  const authStore = useAuthStore();
  const requiresAuth = to.matched.some(record => record.meta.requiresAuth);
  const requiresGuest = to.matched.some(record => record.meta.requiresGuest);

  if (requiresAuth && !authStore.isAuthenticated) {
    next('/login');
  } else if (requiresGuest && authStore.isAuthenticated) {
    next('/dashboard');
  } else {
    next();
  }
});

export default router;
```

## معايير التطوير

### 1. أسلوب التسمية

- **المتغيرات والدوال**: camelCase (`getUserData`, `bloodPressure`)
- **المكونات**: PascalCase (`MeasurementForm`, `HealthIndicator`)
- **المتاجر**: camelCase مع لاحقة `.store` (`auth.store.ts`)
- **الخدمات**: camelCase مع لاحقة `.service` (`measurements.service.ts`)

### 2. تنظيم الكود

- استخدام TypeScript لتحسين سلامة النوع
- تطبيق مبدأ المسؤولية الواحدة (Single Responsibility Principle)
- فصل منطق العمل عن واجهة المستخدم
- تجنب الدوال الطويلة (أكثر من 30-40 سطرًا)
- كتابة تعليقات للكود المعقد

### 3. التعليقات والتوثيق

- كتابة تعليقات توضيحية للوظائف المعقدة
- توثيق واجهات المكونات (props, events)
- توثيق الخدمات وواجهات البرمجة (APIs)
- استخدام JSDoc لتوثيق الدوال والأنواع

### 4. إدارة الحالة

- استخدام Pinia لإدارة الحالة المركزية
- تقسيم الحالة إلى متاجر منطقية
- استخدام الحالة المحلية (local state) للمكونات البسيطة
- تجنب مشاركة الحالة عبر prop drilling

### 5. التعامل مع الأخطاء

- استخدام try-catch لمعالجة الأخطاء
- إنشاء خدمة مركزية للإبلاغ عن الأخطاء
- عرض رسائل خطأ واضحة ومفيدة للمستخدم
- تسجيل الأخطاء للمراقبة والتتبع

## اختبار التطبيق

### 1. اختبارات الوحدة (Unit Tests)

نستخدم Jest لاختبارات الوحدة:

```typescript
// tests/unit/services/measurements.service.spec.ts
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { MeasurementsService } from '@/services/measurements.service';
import { firebaseService } from '@/services/firebase.service';
import { useAuthStore } from '@/store/auth.store';

// Mock للخدمات والمتاجر
vi.mock('@/services/firebase.service', () => ({
  firebaseService: {
    addDocument: vi.fn(),
    queryDocuments: vi.fn()
  }
}));

vi.mock('@/store/auth.store', () => ({
  useAuthStore: vi.fn()
}));

describe('MeasurementsService', () => {
  let service: MeasurementsService;
  
  beforeEach(() => {
    vi.clearAllMocks();
    
    // Mock للمتجر
    (useAuthStore as any).mockReturnValue({
      user: { uid: 'test-user-id' }
    });
    
    service = new MeasurementsService();
  });
  
  describe('addMeasurement', () => {
    it('should add a measurement with userId and timestamp', async () => {
      const mockMeasurement = { type: 'weight', value: 75 };
      
      await service.addMeasurement(mockMeasurement);
      
      expect(firebaseService.addDocument).toHaveBeenCalledWith(
        'measurements',
        expect.objectContaining({
          type: 'weight',
          value: 75,
          userId: 'test-user-id',
          timestamp: expect.any(Date),
          date: expect.any(String)
        })
      );
    });
    
    it('should throw an error if user is not logged in', async () => {
      (useAuthStore as any).mockReturnValue({ user: null });
      
      await expect(
        service.addMeasurement({ type: 'weight', value: 75 })
      ).rejects.toThrow('المستخدم غير مسجل الدخول');
    });
  });
  
  // المزيد من الاختبارات...
});
```

### 2. اختبارات المكونات

```typescript
// tests/unit/components/MeasurementForm.spec.ts
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { mount } from '@vue/test-utils';
import MeasurementForm from '@/components/measurements/MeasurementForm.vue';
import { useMeasurementsStore } from '@/store/measurements.store';

// Mock للمتاجر
vi.mock('@/store/measurements.store', () => ({
  useMeasurementsStore: vi.fn()
}));

describe('MeasurementForm', () => {
  let wrapper;
  const mockAddMeasurement = vi.fn();
  
  beforeEach(() => {
    vi.clearAllMocks();
    
    // Mock للمتجر
    (useMeasurementsStore as any).mockReturnValue({
      addMeasurement: mockAddMeasurement
    });
    
    wrapper = mount(MeasurementForm, {
      props: {
        measurementType: 'weight',
        title: 'تسجيل الوزن',
        label: 'الوزن',
        unit: 'كجم',
        placeholder: 'أدخل وزنك',
        step: '0.1'
      }
    });
  });
  
  it('renders correctly with props', () => {
    expect(wrapper.find('h3').text()).toBe('تسجيل الوزن');
    expect(wrapper.find('label[for="value"]').text()).toBe('الوزن');
    expect(wrapper.find('.unit').text()).toBe('كجم');
    expect(wrapper.find('input').attributes('placeholder')).toBe('أدخل وزنك');
    expect(wrapper.find('input').attributes('step')).toBe('0.1');
  });
  
  it('submits the form with correct data', async () => {
    // تعبئة النموذج
    const input = wrapper.find('input');
    const textarea = wrapper.find('textarea');
    
    await input.setValue('75.5');
    await textarea.setValue('بعد الإفطار');
    
    // تقديم النموذج
    await wrapper.find('form').trigger('submit');
    
    // التحقق من استدعاء الوظيفة
    expect(mockAddMeasurement).toHaveBeenCalledWith(
      expect.objectContaining({
        type: 'weight',
        value: 75.5,
        unit: 'كجم',
        notes: 'بعد الإفطار'
      })
    );
  });
  
  // المزيد من الاختبارات...
});
```

### 3. اختبارات واجهة المستخدم (E2E)

نستخدم Cypress لاختبارات واجهة المستخدم النهائية:

```typescript
// cypress/e2e/measurements.cy.ts
describe('Measurements Feature', () => {
  beforeEach(() => {
    // Mock للمصادقة
    cy.login('test@example.com', 'password');
    cy.visit('/measurements');
  });
  
  it('allows adding a new weight measurement', () => {
    // العثور على نموذج الوزن
    cy.contains('تسجيل الوزن').parent().within(() => {
      cy.get('input[type="number"]').type('75.5');
      cy.get('textarea').type('بعد الإفطار');
      cy.get('button[type="submit"]').click();
    });
    
    // التحقق من الإضافة
    cy.contains('تم إضافة القياس بنجاح').should('be.visible');
    
    // التحقق من عرض القياس في القائمة
    cy.get('.measurement-list').contains('75.5 كجم').should('be.visible');
  });
  
  // المزيد من الاختبارات...
});
```

## الأمان والممارسات الموصى بها

### 1. مصادقة وتفويض المستخدم

- استخدام Firebase Authentication للمصادقة الآمنة
- التحقق من صحة المدخلات على جانب العميل والخادم
- تنفيذ قواعد أمان Firestore المناسبة
- استخدام وحدات حماية التوجيه (route guards)

### 2. أمان البيانات

- التحقق من صحة البيانات قبل تخزينها
- تشفير البيانات الحساسة
- استخدام HTTPS لجميع الاتصالات
- تنفيذ آليات النسخ الاحتياطي المنتظم

### 3. الأداء

- استخدام التخزين المؤقت للبيانات المستخدمة بشكل متكرر
- تجنب استعلامات قاعدة البيانات غير الضرورية
- كسل تحميل المكونات والمسارات (lazy loading)
- تحسين حجم الصور والموارد

### 4. الصيانة

- كتابة اختبارات شاملة
- توثيق الكود والوظائف
- استخدام إدارة الإصدارات (Git)
- مراجعة الكود بشكل منتظم

## استعلامات قاعدة البيانات الشائعة

### 1. الحصول على قياسات المستخدم حسب النوع

```typescript
/**
 * الحصول على قياسات المستخدم من نوع معين
 * @param userId معرف المستخدم
 * @param type نوع القياس (weight, blood_pressure, glucose, etc.)
 * @param limit عدد النتائج (اختياري، افتراضي 10)
 * @returns وعد بمصفوفة من وثائق القياسات
 */
async function getUserMeasurementsByType(userId, type, limit = 10) {
  return await firebaseService.queryDocuments(
    'measurements',
    [
      { field: 'userId', operator: '==', value: userId },
      { field: 'type', operator: '==', value: type }
    ],
    { field: 'timestamp', direction: 'desc' },
    limit
  );
}
```

### 2. الحصول على تذكيرات اليوم

```typescript
/**
 * الحصول على تذكيرات اليوم للمستخدم
 * @param userId معرف المستخدم
 * @returns وعد بمصفوفة من وثائق التذكيرات
 */
async function getTodayReminders(userId) {
  const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
  
  return await firebaseService.queryDocuments(
    'reminders',
    [
      { field: 'userId', operator: '==', value: userId },
      { field: 'date', operator: '==', value: today }
    ],
    { field: 'time', direction: 'asc' }
  );
}
```

### 3. الحصول على التحاليل الطبية الأخيرة

```typescript
/**
 * الحصول على التحاليل الطبية الأخيرة للمستخدم
 * @param userId معرف المستخدم
 * @param limit عدد النتائج (اختياري، افتراضي 5)
 * @returns وعد بمصفوفة من وثائق التحاليل
 */
async function getRecentMedicalTests(userId, limit = 5) {
  return await firebaseService.queryDocuments(
    'medicalTests',
    [
      { field: 'userId', operator: '==', value: userId }
    ],
    { field: 'date', direction: 'desc' },
    limit
  );
}
```

## حل المشكلات الشائعة

### 1. أخطاء الفهارس في Firestore

**المشكلة**: ظهور خطأ "The query requires an index"

**الحل**: 
- انقر على الرابط الذي يظهر في رسالة الخطأ لإنشاء الفهرس المطلوب
- أو قم بإنشاء الفهرس يدويًا من لوحة تحكم Firebase
- تأكد من وجود جميع الفهارس المركبة المذكورة في وثيقة [هيكلة قاعدة البيانات](./هيكلة-قاعدة-البيانات.md)

### 2. مشكلات المصادقة

**المشكلة**: المستخدم يظل مسجلاً للخروج بعد تسجيل الدخول

**الحل**:
- تأكد من تخزين حالة المستخدم في متجر Auth بشكل صحيح
- تحقق من تنفيذ مستمع حالة المصادقة (Auth State Listener)
- افحص وحدات حماية التوجيه (route guards)

```typescript
// تنفيذ مستمع حالة المصادقة
import { onAuthStateChanged } from 'firebase/auth';

onAuthStateChanged(auth, (user) => {
  const authStore = useAuthStore();
  authStore.setUser(user);
});
```

### 3. التعامل مع الاتصال المتقطع

**المشكلة**: فقدان البيانات عند انقطاع الاتصال بالإنترنت

**الحل**:
- تنفيذ وضع غير متصل (offline mode) باستخدام تخزين محلي
- تنفيذ قائمة انتظار للعمليات عندما يكون الاتصال مقطوعًا
- مزامنة البيانات عند استعادة الاتصال

```typescript
// تنفيذ مراقب اتصال
export function setupConnectivityMonitoring() {
  const store = useAppStore();
  
  window.addEventListener('online', () => {
    store.setConnectivity(true);
    // مزامنة البيانات المعلقة
    syncPendingData();
  });
  
  window.addEventListener('offline', () => {
    store.setConnectivity(false);
  });
}
```

## الموارد الإضافية

- [وثائق Vue.js](https://vuejs.org/guide/introduction.html)
- [وثائق Pinia](https://pinia.vuejs.org/introduction.html)
- [وثائق Firebase](https://firebase.google.com/docs)
- [Firestore Security Rules](https://firebase.google.com/docs/firestore/security/get-started)
- [مكتبة Vue Test Utils](https://test-utils.vuejs.org/)
- [وثائق Cypress](https://docs.cypress.io/)

---

*ملاحظة: هذا الدليل قابل للتحديث والتطوير مع تقدم المشروع.*